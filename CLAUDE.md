# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリでコードを扱う際のガイダンスを **日本語** で提供します。

## プロジェクト概要

本プロジェクト「amadeus」は 音声秘書 AI です。
Raspberry Pi 上で動作する音声対話型秘書 AI の開発。雑談・検索・タスク管理を包括的に処理し、将来的にはアレクサ連携やクラウド同期にも対応。

また、**Clean Architecture** 原則に従った **Python / FastAPI** アプリケーションになっています。

## 基本方針

- **プラットフォーム**: Raspberry Pi 4 で完結
- **開発フロー**: PC 開発 → GitHub → ラズパイで clone → localhost 起動
- **データ保存**: ローカル保存 (将来クラウド同期対応)
- **拡張性**: 段階的機能追加、アレクサ連携準備

## 技術構成

### ハードウェア

- **Raspberry Pi 4** (メモリ 4GB 以上推奨)
- **USB マイク** or **I2S マイク** (ReSpeaker 等)
- **スピーカー** (USB/3.5mm/Bluetooth)
- **microSD カード** (64GB 以上)

### ソフトウェアスタック

```
音声入力 → ウェイクワード検出 → 音声認識 → AI処理 → 音声合成 → 出力
```

### 各コンポーネント

- **ウェイクワード検出**: pvporcupine
- **音声認識**: OpenAI Whisper API
- **会話処理**: agents sdk + 4o-mini
- **機能拡張**: MCP (Model Context Protocol)
- **音声合成**: VOICEVOX (ずんだもん等)

## 音声処理の仕組み

### 2 段階録音システム

1. **常時録音**: ウェイクワード検出用

   - 短時間バッファ (1-2 秒)
   - リアルタイム判定
   - 検出されなければ破棄

2. **メイン録音**: 音声認識用
   - ウェイクワード検出後に開始
   - 話し終わりまで録音継続
   - Whisper API に送信

## 機能要件

### コア機能 (必須)

- **音声対話**: 雑談、質問応答、情報検索
- **タスク管理**: 予定追加/確認、リマインダー、ToDo リスト
- **情報取得**: 天気、ニュース、時刻、計算

### 拡張機能 (段階的追加)

- **ファイル操作**: メモ作成、文書検索
- **メール/メッセージ**: 送信、受信確認
- **学習機能**: ユーザーの好み記憶、会話履歴活用
- **システム制御**: ラズパイ設定、再起動等

### 将来拡張 (アレクサ連携後)

- **スマートホーム**: 照明、エアコン、音楽再生
- **外部 API 連携**: 買い物リスト、配達確認等

## 実装フェーズ

### フェーズ 1: 基本会話

1. **音声入出力テスト**: マイク/スピーカー動作確認
2. **agents sdk 連携**: 4o-mini との基本対話 (PC 開発)
3. **ウェイクワード検出**: 起動トリガー実装
4. **音声認識**: 話し終わり検出とテキスト変換
5. **音声合成**: VOICEVOX 統合

### フェーズ 2: 機能拡張

- MCP 追加 (カレンダー、メール等)
- 会話履歴・学習機能
- タスク管理機能強化

### フェーズ 3: 将来対応

- クラウド同期機能
- アレクサ連携準備
- スマートホーム統合

## 次のステップ

1. agents sdk + 4o-mini の基本対話実装 (PC)
2. テキストベースでの動作確認
3. 音声入出力機能の段階的追加

## 注意事項

- **API キー管理**: 環境変数で設定
- **音声データ**: プライバシー考慮したローカル処理
- **著作権**: VOICEVOX 利用規約遵守

## 開発環境

- **Python 3.11 以降** のランタイム
- **FastAPI** Web フレームワーク
- 開発ツール: `git`, `zsh`, `fzf`, `gh` (GitHub CLI), `jq`
- ネットワークユーティリティ: `iptables`, `ipset`, `iproute2`, `dnsutils`
- VS Code 拡張: Python, Pylint, Black (保存時に自動フォーマット)
- **Claude Code CLI** をグローバルインストール済み

## リポジトリ構成

- Clean Architecture に従った FastAPI アプリケーション
- Python 開発用に設定された **devcontainer**
- `main` ブランチで初期化された Git リポジトリ

## アーキテクチャ規約

このプロジェクトは Clean Architecture の原則に従い、以下のレイヤを持ちます。

### レイヤ構成

1. **Entity** – コアとなるビジネスエンティティとドメインモデル
2. **UseCase** – アプリケーションのビジネスロジック
3. **Gateway** – 外部システムとのインターフェース
4. **Repository** – データ永続化のインターフェース
5. **Router** – FastAPI ルーティングとリクエスト処理

### アーキテクチャガイドライン

- **依存性ルール**: 依存は内向きにのみ向ける。外側のレイヤは内側に依存できるが、その逆は不可。
- **Entity レイヤ**: 外部依存のない純粋なビジネスロジックを含む。
- **UseCase レイヤ**: Entity と Repository / Gateway インターフェースを用いてビジネス処理を調整する。
- **Repository / Gateway**: インターフェースを UseCase レイヤに定義し、実装は Infrastructure レイヤに配置する。
- **Router レイヤ**: HTTP 処理を担当し、UseCase に処理を委譲する。

### ディレクトリ構成

```text
src/
├── domain/
│   ├── entities/      # ビジネスエンティティ (Pydantic ドメインモデル)
│   └── repositories/  # Repository インターフェース (Protocol クラス)
├── usecases/          # アプリケーションビジネスロジック
├── infrastructure/
│   ├── repositories/  # Repository 実装
│   ├── gateways/      # 外部サービス実装
│   └── database/      # DB 接続およびモデル
├── presentation/
│   ├── routers/       # FastAPI ルータ
│   └── schemas/       # リクエスト／レスポンス用 Pydantic モデル
└── main.py            # FastAPI アプリケーションのエントリポイント
```

### 開発指針

- データのバリデーションとシリアライズには **Pydantic** を使用する。
- Repository インターフェースには Python の **Protocol** を用いる。
- FastAPI 依存は **presentation** 層のみに限定する。
- FastAPI の `Depends()` を使った依存性注入を活用する。
- **pytest** を用いて各レイヤを個別にテストする。
- ドメインと UseCase レイヤではフレームワーク依存を避ける。
- コード全体に **型ヒント** を徹底する。

### FastAPI 固有ガイドライン

- Router は薄く保ち、処理を UseCase に委譲する。
- リクエスト／レスポンススキーマにはドメインエンティティとは分離した **Pydantic** モデルを使用する。
- Repository 実装の注入には FastAPI の依存性注入機構を利用する。
- エラーは適切な **HTTP ステータスコード** でハンドリングする。
- I/O 操作には **async/await** を用いる。

## 開発ノート

- devcontainer には Claude Code がプリインストールされており、完全な開発環境を提供する。
- VS Code は Pylint と Black により保存時自動フォーマットが行われる。
- ネットワーク機能はネットワーク関連開発が可能なように設定済み。
- 新規コードは常に Clean Architecture 原則に従うこと。
- FastAPI の機能を活用しつつ、レイヤ間の境界を明確に保つこと。

---

### 会話言語に関する指示

**以降、Claude Code との対話は必ず日本語で行ってください。**
